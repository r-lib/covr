# covr

Track test coverage for your R package and view reports locally or
(optionally) upload the results to [codecov](https://about.codecov.io/)
or [coveralls](https://coveralls.io/).

# Installation

``` r
install.packages("covr")

# For devel version
devtools::install_github("r-lib/covr")
```

The easiest way to setup covr on [Github
Actions](https://github.com/r-lib/actions/tree/v2-branch/examples#test-coverage-workflow)
is with [usethis](https://github.com/r-lib/usethis).

``` r
usethis::use_github_action("test-coverage")
```

# Usage

For local development a coverage report can be used to inspect coverage
for each line in your package. *Note* requires the
[DT](https://github.com/rstudio/DT) package to be installed.

``` r
library(covr)

# If run with no arguments implicitly calls `package_coverage()`
report()
```

covr also defines an [RStudio
Addin](https://rstudio.github.io/rstudioaddins/), which runs
[`report()`](https://covr.r-lib.org/dev/reference/report.md) on the
active project. This can be used via the Addin menu or by binding the
action to a
[shortcut](https://rstudio.github.io/rstudioaddins/#keyboard-shorcuts),
e.g. *Ctrl-Shift-C*.

## Interactively

``` r
# If run with the working directory within the package source.
package_coverage()

# or a package in another directory
cov <- package_coverage("/dir/lintr")

# view results as a data.frame
as.data.frame(cov)

# zero_coverage() shows only uncovered lines.
# If run within RStudio, `zero_coverage()` will open a marker pane with the
# uncovered lines.
zero_coverage(cov)
```

# Exclusions

`covr` supports a few of different ways of excluding some or all of a
file.

## .covrignore file

A `.covrignore` file located in your package’s root directory can be
used to exclude files or directories.

The lines in the `.covrignore` file are interpreted as a list of file
globs to ignore. It uses the globbing rules in
[`Sys.glob()`](https://rdrr.io/r/base/Sys.glob.html). Any directories
listed will ignore all the files in the directory.

Alternative locations for the file can be set by the environment
variable `COVR_COVRIGNORE` or the R option `covr.covrignore`.

The `.covrignore` file should be added to your `.RBuildignore` file
unless you want to distribute it with your package. If so it can be
added to `inst/.covrignore` instead.

## Function Exclusions

The `function_exclusions` argument to
[`package_coverage()`](https://covr.r-lib.org/dev/reference/package_coverage.md)
can be used to exclude functions by name. This argument takes a vector
of regular expressions matching functions to exclude.

``` r
# exclude print functions
package_coverage(function_exclusions = "print\\.")

# exclude `.onLoad` function
package_coverage(function_exclusions = "\\.onLoad")
```

## Line Exclusions

The `line_exclusions` argument to
[`package_coverage()`](https://covr.r-lib.org/dev/reference/package_coverage.md)
can be used to exclude some or all of a file. This argument takes a list
of filenames or named ranges to exclude.

``` r
# exclude whole file of R/test.R
package_coverage(line_exclusions = "R/test.R")

# exclude lines 1 to 10 and 15 from R/test.R
package_coverage(line_exclusions = list("R/test.R" = c(1:10, 15)))

# exclude lines 1 to 10 from R/test.R, all of R/test2.R
package_coverage(line_exclusions = list("R/test.R" = c(1, 10), "R/test2.R"))
```

## Exclusion Comments

In addition you can exclude lines from the coverage by putting special
comments in your source code.

This can be done per line.

``` r
f1 <- function(x) {
  x + 1 # nocov
}
```

Or by specifying a range with a start and end.

``` r
f2 <- function(x) { # nocov start
  x + 2
} # nocov end
```

The patterns used can be specified by setting the global options
`covr.exclude_pattern`, `covr.exclude_start`, `covr.exclude_end`.

NB: The same pattern applies to exclusions in the `src` folder, so
skipped lines in, e.g., C code (where comments can start with `//`)
should look like `// # nocov`.

# FAQ

## Will covr work with testthat, RUnit, etc…

Covr should be compatible with any testing package, it uses
[`tools::testInstalledPackage()`](https://rdrr.io/r/tools/testInstalledPackage.html)
to run your packages tests.

## Will covr work with alternative compilers such as ICC

Covr now supports Intel’s `icc` compiler, thanks to work contributed by
Qin Wang at Oracle.

Covr is known to work with clang versions `3.5+` and gcc version `4.2+`.

If the appropriate gcov version is not on your path you can set the
appropriate location with the `covr.gcov` options. If you set this path
to “” it will turn *off* coverage of compiled code.

``` r
options(covr.gcov = "path/to/gcov")
```

## How does covr work?

`covr` tracks test coverage by modifying a package’s code to add
tracking calls to each call.

The vignette
[vignettes/how_it_works.Rmd](https://github.com/r-lib/covr/blob/master/vignettes/how_it_works.Rmd)
contains a detailed explanation of the technique and the rationale
behind it.

You can view the vignette from within `R` using

``` r
vignette("how_it_works", package = "covr")
```

## Why can’t covr run during R CMD check

Because covr modifies the package code it is possible there are unknown
edge cases where that modification affects the output. In addition when
tracking coverage for compiled code covr compiles the package without
optimization, which *can* modify behavior (usually due to package bugs
which are masked with higher optimization levels).

# Alternative Coverage Tools

- <https://github.com/MangoTheCat/testCoverage> (no longer supported)
- [**R-coverage**](https://web.archive.org/web/20160611114452/http://r2d2.quartzbio.com/posts/r-coverage-docker.html)
  (no longer supported)

## Code of Conduct

Please note that the covr project is released with a [Contributor Code
of Conduct](https://github.com/r-lib/covr/blob/main/CODE_OF_CONDUCT.md).
By contributing to this project, you agree to abide by its terms.

# Package index

## All functions

- [`as_coverage()`](https://covr.r-lib.org/dev/reference/as_coverage.md)
  : Convert a counters object to a coverage object
- [`as_coverage_with_tests()`](https://covr.r-lib.org/dev/reference/as_coverage_with_tests.md)
  : Clean and restructure counter tests for a coverage object
- [`azure()`](https://covr.r-lib.org/dev/reference/azure.md) : Run covr
  on a package and output the result so it is available on Azure
  Pipelines
- [`code_coverage()`](https://covr.r-lib.org/dev/reference/code_coverage.md)
  : Calculate coverage of code directly
- [`codecov()`](https://covr.r-lib.org/dev/reference/codecov.md) : Run
  covr on a package and upload the result to codecov.io
- [`coverage_to_list()`](https://covr.r-lib.org/dev/reference/coverage_to_list.md)
  : Convert a coverage dataset to a list
- [`coveralls()`](https://covr.r-lib.org/dev/reference/coveralls.md) :
  Run covr on a package and upload the result to coveralls
- [`covr`](https://covr.r-lib.org/dev/reference/covr-package.md)
  [`covr-package`](https://covr.r-lib.org/dev/reference/covr-package.md)
  : covr: Test coverage for packages
- [`covr.record_tests`](https://covr.r-lib.org/dev/reference/covr.record_tests.md)
  : Record Test Traces During Coverage Execution
- [`current_test_call_count()`](https://covr.r-lib.org/dev/reference/current_test_call_count.md)
  : Retrieve the number of times the test call was called
- [`environment_coverage()`](https://covr.r-lib.org/dev/reference/environment_coverage.md)
  : Calculate coverage of an environment
- [`exclusions`](https://covr.r-lib.org/dev/reference/exclusions.md) :
  Exclusions
- [`file_coverage()`](https://covr.r-lib.org/dev/reference/file_coverage.md)
  : Calculate test coverage for sets of files
- [`file_report()`](https://covr.r-lib.org/dev/reference/file_report.md)
  : A coverage report for a specific file
- [`function_coverage()`](https://covr.r-lib.org/dev/reference/function_coverage.md)
  : Calculate test coverage for a specific function.
- [`gitlab()`](https://covr.r-lib.org/dev/reference/gitlab.md) : Run
  covr on package and create report for GitLab
- [`has_srcref()`](https://covr.r-lib.org/dev/reference/has_srcref.md) :
  Is the source bound to the expression
- [`in_covr()`](https://covr.r-lib.org/dev/reference/in_covr.md) :
  Determine if code is being run in covr
- [`is_covr_count_call()`](https://covr.r-lib.org/dev/reference/is_covr_count_call.md)
  : Is the expression a call to covr:::count
- [`is_current_test_finished()`](https://covr.r-lib.org/dev/reference/is_current_test_finished.md)
  : Returns TRUE if we've moved on from test reflected in .current_test
- [`new_test_counter()`](https://covr.r-lib.org/dev/reference/new_test_counter.md)
  : Initialize a new test counter for a coverage trace
- [`package_coverage()`](https://covr.r-lib.org/dev/reference/package_coverage.md)
  : Calculate test coverage for a package
- [`percent_coverage()`](https://covr.r-lib.org/dev/reference/percent_coverage.md)
  : Provide percent coverage of package
- [`print(`*`<coverage>`*`)`](https://covr.r-lib.org/dev/reference/print.coverage.md)
  : Print a coverage object
- [`report()`](https://covr.r-lib.org/dev/reference/report.md) : Display
  covr results using a standalone report
- [`tally_coverage()`](https://covr.r-lib.org/dev/reference/tally_coverage.md)
  : Tally coverage by line or expression
- [`to_cobertura()`](https://covr.r-lib.org/dev/reference/to_cobertura.md)
  : Create a Cobertura XML file
- [`to_sonarqube()`](https://covr.r-lib.org/dev/reference/to_sonarqube.md)
  : Create a SonarQube Generic XML file for test coverage according to
  https://docs.sonarqube.org/latest/analysis/generic-test/ Based on
  cobertura.R
- [`truncate_call()`](https://covr.r-lib.org/dev/reference/truncate_call.md)
  : Truncate call objects to limit the number of arguments
- [`value()`](https://covr.r-lib.org/dev/reference/value.md) : Retrieve
  the value from an object
- [`zero_coverage()`](https://covr.r-lib.org/dev/reference/zero_coverage.md)
  : Provide locations of zero coverage

# Articles

### All vignettes

- [How does covr work
  anyway?](https://covr.r-lib.org/dev/articles/how_it_works.md):
